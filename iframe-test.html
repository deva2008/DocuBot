<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuBot Studio - Iframe Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fafafa;
        }
        .test-section h2 {
            margin-top: 0;
            color: #0066cc;
            font-size: 18px;
        }
        .test-section p {
            margin: 10px 0;
            color: #666;
            font-size: 14px;
        }
        .test-section code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        iframe {
            border: 2px solid #0066cc;
            border-radius: 4px;
            background: white;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: 500;
        }
        .status.active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.inactive {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .instructions {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 5px 5px 0;
        }
        button:hover {
            background: #0052a3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ DocuBot Studio - Iframe Embedding Tests</h1>
        <p>This page tests different iframe sandbox configurations to identify the blocker preventing DocuBot Studio from loading.</p>

        <!-- TEST A: Quick Test - Remove Sandbox Entirely (Debug Only) -->
        <div class="test-section">
            <h2>Test A: Quick Test ‚Äî Remove Sandbox (Debug Only)</h2>
            <p><strong>Status:</strong> <span class="status active">ACTIVE</span></p>
            <div class="instructions">
                <strong>‚ö†Ô∏è Security Note:</strong> This removes all sandboxing. Use ONLY for testing to confirm WebSocket is the blocker. <strong>Do not use in production.</strong>
            </div>
            <p><strong>What to expect:</strong></p>
            <ul>
                <li>DevTools ‚Üí Network ‚Üí filter "WS" should show <code>wss://.../_logstream</code> with status <strong>101 Switching Protocols</strong></li>
                <li>Console errors about "WebSocket connection failed" should disappear</li>
                <li>Upload UI should render (no white screen)</li>
            </ul>
            <p><strong>Verification:</strong> Open DevTools (F12) ‚Üí Network tab ‚Üí Filter by "WS" ‚Üí Reload this page. Look for successful wss:// connection.</p>
            <iframe
                id="testA"
                src="https://docubot-studio.streamlit.app"
                style="width:100%; height:600px; border:0; min-height:720px;"
                title="DocuBot Studio (Test A - No Sandbox)">
            </iframe>
        </div>

        <!-- TEST B: Safer Sandbox Configuration (Recommended Production) -->
        <div class="test-section">
            <h2>Test B: Safer Sandbox (Recommended Production)</h2>
            <p><strong>Status:</strong> <span class="status inactive">INACTIVE</span></p>
            <div class="instructions">
                <strong>‚úÖ Recommended:</strong> Allows scripts and forms but NOT same-origin. This prevents sandbox escape while still allowing WebSocket connections.
            </div>
            <p><strong>Key difference from Test A:</strong> Removes <code>allow-same-origin</code> to prevent browser warnings while keeping sandbox protection.</p>
            <p><strong>What to expect:</strong></p>
            <ul>
                <li>Upload UI should render (no white screen)</li>
                <li>WebSocket connection should succeed (check DevTools ‚Üí Network ‚Üí WS)</li>
                <li>No sandbox escape warnings in console</li>
            </ul>
            <button onclick="toggleTestB()">Enable Test B</button>
            <div id="testB-container" style="display:none;">
                <iframe
                    id="testB"
                    src="https://docubot-studio.streamlit.app"
                    style="width:100%; height:600px; border:0; min-height:720px;"
                    sandbox="allow-scripts allow-forms allow-popups"
                    title="DocuBot Studio (Test B - Safer Sandbox)">
                </iframe>
            </div>
        </div>

        <!-- TEST C: Reverse Proxy (Robust Production Option) -->
        <div class="test-section">
            <h2>Test C: Reverse Proxy (Robust Production Option)</h2>
            <p><strong>Status:</strong> <span class="status inactive">INACTIVE</span></p>
            <div class="instructions">
                <strong>üîí Use if:</strong> Test A & B fail, or you need same-origin access, or host blocks framing via headers.
            </div>
            <p><strong>Setup required:</strong> You must configure an nginx reverse proxy on your domain first.</p>
            <p><strong>Nginx config (paste into your server block):</strong></p>
            <pre style="background:#f0f0f0; padding:15px; border-radius:4px; overflow-x:auto; font-size:12px;">location /docubot/ {
    proxy_pass https://docubot-studio.streamlit.app/;
    proxy_set_header Host docubot-studio.streamlit.app;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # WebSocket support (critical)
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    proxy_buffering off;
    proxy_read_timeout 86400;
}</pre>
            <p><strong>Then embed using your proxied URL:</strong></p>
            <pre style="background:#f0f0f0; padding:15px; border-radius:4px; overflow-x:auto; font-size:12px;">&lt;iframe
  src="https://yourdomain.com/docubot/"
  style="width:100%; height:900px; border:0;"
  title="DocuBot Studio (proxy)"&gt;
&lt;/iframe&gt;</pre>
            <p><strong>Why this works:</strong> Browser sees same-origin, WebSocket upgrade works reliably, X-Frame-Options headers are bypassed.</p>
        </div>

        <!-- TEST 4: Header Check -->
        <div class="test-section">
            <h2>Test 4: Check Response Headers</h2>
            <p><strong>Status:</strong> <span class="status inactive">INACTIVE</span></p>
            <div class="instructions">
                <strong>‚ÑπÔ∏è Purpose:</strong> Check if the Streamlit app blocks framing via X-Frame-Options or CSP headers.
            </div>
            <button onclick="checkHeaders()">Check Headers</button>
            <div id="header-results" style="margin-top: 15px; display:none; background: #f0f0f0; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; word-break: break-all;"></div>
        </div>

        <!-- TEST 5: WebSocket Check -->
        <div class="test-section">
            <h2>Test 5: WebSocket Connectivity</h2>
            <p><strong>Status:</strong> <span class="status inactive">INACTIVE</span></p>
            <div class="instructions">
                <strong>‚ÑπÔ∏è Purpose:</strong> Streamlit requires WebSocket (wss://) connections. Check DevTools ‚Üí Network ‚Üí filter "WS" to see if wss:// connections succeed.
            </div>
            <p>Open DevTools (F12 or Cmd+Option+I) ‚Üí Network tab ‚Üí Filter by "WS" ‚Üí Then enable Test 1 or Test 2 above and reload the iframe.</p>
            <p>Look for <code>wss://</code> connections. If they fail or don't appear, WebSocket is blocked.</p>
        </div>

        <!-- AUTHENTICATION CHECK -->
        <div class="test-section" style="background: #fff3cd; border-color: #ffc107;">
            <h2 style="color: #856404;">üîê Authentication Issue Detected</h2>
            <p><strong>Problem:</strong> The Streamlit app is redirecting to an authentication page, which causes a blank iframe.</p>
            <p><strong>Solution:</strong> You need to do ONE of the following:</p>
            <ol>
                <li><strong>Make the Streamlit app public:</strong> Share the app publicly so it doesn't require authentication</li>
                <li><strong>Use a public share link:</strong> If you have a public Streamlit share link, use that URL instead</li>
                <li><strong>Authenticate before embedding:</strong> Open the app in a separate tab first to authenticate, then the iframe may work</li>
                <li><strong>Use a reverse proxy with auth:</strong> Proxy the app through your own server and handle authentication there</li>
            </ol>
            <p><strong>Check your Streamlit app settings:</strong> Go to <code>https://share.streamlit.io</code> and verify the app is set to "Public" sharing.</p>
        </div>

        <!-- PRODUCTION RECOMMENDATION -->
        <div class="test-section" style="background: #e8f5e9; border-color: #4caf50;">
            <h2 style="color: #2e7d32;">üìã Quick Decision Tree</h2>
            <p><strong>Test A (no sandbox) works?</strong> ‚Üí Use Test B (safer sandbox) for production</p>
            <p><strong>Test B (safer sandbox) works?</strong> ‚Üí ‚úÖ Use this in production</p>
            <p><strong>Both A & B fail?</strong> ‚Üí Use Test C (reverse proxy) or check headers</p>
            <p><strong>curl shows X-Frame-Options: DENY?</strong> ‚Üí Must use Test C (reverse proxy)</p>
        </div>

        <!-- WEBSOCKET VERIFICATION -->
        <div class="test-section" style="background: #e3f2fd; border-color: #2196F3;">
            <h2 style="color: #1565c0;">üîå WebSocket Verification Steps</h2>
            <ol>
                <li>Open DevTools: <code>F12</code> or <code>Cmd+Option+I</code> (Mac)</li>
                <li>Go to <strong>Network</strong> tab</li>
                <li>Filter by <strong>"WS"</strong> (WebSocket)</li>
                <li>Reload this page or enable a test above</li>
                <li>Look for <code>wss://docubot-studio.streamlit.app/_logstream</code></li>
                <li><strong>Success:</strong> Status shows <code>101 Switching Protocols</code></li>
                <li><strong>Failure:</strong> Shows <code>failed</code> or doesn't appear</li>
            </ol>
            <p><strong>If WebSocket fails:</strong> The sandbox or network is blocking it. Try Test A first, then Test B.</p>
        </div>
    </div>

    <script>
        function toggleTestB() {
            const container = document.getElementById('testB-container');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }

        async function checkHeaders() {
            const resultsDiv = document.getElementById('header-results');
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = 'Checking headers...';

            try {
                const response = await fetch('https://docubot-studio.streamlit.app', {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                
                // With no-cors, we can't read headers directly from fetch
                // Instead, show instructions for curl
                resultsDiv.textContent = `
CORS prevents reading headers from browser. Use this command in terminal:

curl -I https://docubot-studio.streamlit.app

Look for these headers in the output:
- X-Frame-Options: (if DENY or SAMEORIGIN, framing is blocked)
- Content-Security-Policy: frame-ancestors (if 'none', framing is blocked)

If you see these headers blocking framing, you'll need a reverse proxy.
                `;
            } catch (error) {
                resultsDiv.textContent = `Error: ${error.message}\n\nUse curl command instead:\ncurl -I https://docubot-studio.streamlit.app`;
            }
        }

        // Log when page loads
        console.log('DocuBot Studio iframe test page loaded');
        console.log('Open DevTools (F12) to see console logs and Network tab for WebSocket connections');
    </script>
</body>
</html>
